# MT4 EA「EURUSD_Surge_EA_Advanced_Improved」損切ロジック改修 システム要件定義書 (改訂版: バッファ計算変更)

## 1. 概要

本ドキュメントは、既存のMT4 EA「EURUSD_Surge_EA_Advanced_Improved」に対し、1分足（M1）のZigZagインジケーターに基づいた新しい損切（Stop Loss, SL）ロジックを追加するためのシステム要件を定義する。
**改訂:** 損切バッファの計算方法を、固定pipsから「エントリー価格とZigZagポイント間の距離に対する割合」に変更する。

## 2. 背景

現行のEAは、ATRまたはサージ起点に基づいたSL計算ロジックを持つ。ユーザーは、エントリー直前の短期的な価格の節目（ZigZagの高値/安値）をSL設定の基準とし、そのバッファを市場のボラティリティ（エントリーポイントとZigZagポイントの距離）に応じて変動させることで、より柔軟なリスク管理を行いたいと考えている。

## 3. 機能要件

### 3.1. 新規損切ロジックの追加

- 既存のSL計算ロジック（ATRベース、サージ起点ベース）に加え、ZigZag指標に基づくSL計算ロジックを新たに追加する。
- ユーザーがEAのパラメータ設定により、どのSL計算ロジックを使用するか選択できるようにする。

### 3.2. ZigZagベースSL計算処理

- EAが指値注文（Buy Limit / Sell Limit）を発注する直前のタイミングで、以下の処理を実行する。
    1.  **対象時間足:** ユーザー指定の時間足（`ZigZagTimeFrame`、デフォルト: PERIOD_M1）のチャートデータを参照する。
    2.  **使用指標:** MT4標準搭載のZigZagインジケーターを使用する（パラメータはユーザー設定）。
    3.  **高値/安値の特定:**
        - 買い注文（Buy Limit）の場合: 指定された期間（`ZigZagMaxLookback`）内で、直近のZigZagの**安値（Trough）** を特定する。
        - 売り注文（Sell Limit）の場合: 指定された期間（`ZigZagMaxLookback`）内で、直近のZigZagの**高値（Peak）** を特定する。
        - *考慮事項: ZigZagはリペイント（再描画）する可能性があるため、最新のポイントではなく、一つ前の確定したポイントを参照することも検討する（要パラメータ化または仕様決定）。本定義ではまず直近のポイントを探す仕様とするが、リペイントリスクは認識しておく。*
    4.  **SL価格の計算:**
        - **距離の計算:** 指値エントリー価格 (`entryPrice`) と特定したZigZagポイント価格 (`zzPoint`) との絶対価格差 `distance = abs(entryPrice - zzPoint)` を計算する。
        - **バッファ値の計算:** 距離 `distance` にユーザー指定の**バッファ率（`ZigZagBufferPercent` / 100.0）** を乗じてバッファ値 `bufferValue = distance * (ZigZagBufferPercent / 100.0)` を計算する。
        - **SL価格の決定:**
            - 買い注文の場合: SL価格 = `zzPoint - bufferValue`
            - 売り注文の場合: SL価格 = `zzPoint + bufferValue`
        - *注意: `distance` が非常に小さい、またはゼロの場合の処理を考慮する（例: 最小バッファ値を設定するか、デフォルトSLにフォールバック）。本定義では、計算結果がエントリー価格に対して不利にならない限りそのまま使用する。*
    5.  **ブローカー最小値の考慮:** 計算されたSL価格が、ブローカーの定める最小ストップレベル（`MODE_STOPLEVEL`）よりもエントリー価格に近い場合は、現行ロジックと同様に、最小ストップレベルに安全マージンを加えた価格に自動調整する。
    6.  **ZigZagポイント未発見時の処理:** 指定された期間内に有効なZigZagの高値/安値が見つからなかった場合、または計算されたSL価格が無効（例: エントリー価格より有利）になった場合の代替処理を定義する。`ZigZagFallbackToDefaultSL` が true なら現行のATRベースまたはサージ起点ベースのSL計算ロジックにフォールバックし、false なら注文自体を見送る（推奨：フォールバック）。

### 3.3. 既存機能への影響

- **テイクプロフィット（TP）計算:** TPはSLまでの距離とリスクリワード比に基づいて計算されるため、新しいSLロジックを使用した場合、TP価格も自動的に調整される。リスクリワード比の計算ロジック自体は変更しない。
- **ポジションサイジング:** リスク許容率に基づくポジションサイジングは、エントリー価格とSL価格の差に基づいて計算されるため、新しいSLロジックを使用した場合、ロットサイズも自動的に調整される。計算ロジック自体は変更しない。
- **トレンド分析・エントリーロジック:** 5分足/15分足を使用する既存のトレンド分析、サージ検出、エントリータイミング判断ロジックは変更しない。

## 4. 非機能要件

### 4.1. パラメータ設定

- 以下の項目をEAの外部パラメータ（`extern`）として追加・変更し、ユーザーが設定できるようにする。
    - `UseZigZagStopLoss` (bool): ZigZagベースSLを使用するかどうか (デフォルト: `true`)
    - `ZigZagTimeFrame` (ENUM_TIMEFRAMES): ZigZag計算に使用する時間足 (デフォルト: `PERIOD_M1`)
    - `ZigZagDepth` (int): ZigZagの `ExtDepth` パラメータ (デフォルト: 12)
    - `ZigZagDeviation` (int): ZigZagの `ExtDeviation` パラメータ (デフォルト: 5)
    - `ZigZagBackstep` (int): ZigZagの `ExtBackstep` パラメータ (デフォルト: 3)
    - **`ZigZagBufferPercent` (double): ZigZagポイントとエントリー価格の距離に対するバッファ率（%） (デフォルト: 15.0)**
    - `ZigZagMaxLookback` (int): ZigZagポイントを探す最大遡及バー数（`ZigZagTimeFrame`基準） (デフォルト: 100)
    - `ZigZagFallbackToDefaultSL` (bool): ZigZagポイントが見つからない場合や計算結果が無効な場合にデフォルトSLロジックを使用するかどうか (デフォルト: `true`)

### 4.2. パフォーマンス

- 新規ロジック追加によるEA全体のパフォーマンス（処理速度）への影響を最小限に抑える。`iCustom` 関数の呼び出しは注文準備時に限定する。

### 4.3. ログ出力

- ZigZagベースSL計算の実行、特定されたZigZagポイントの価格と時刻、計算された距離、バッファ値、最終的なSL価格、フォールバック処理の発生などをログに出力し、動作検証を容易にする。

## 5. その他

- バッファ計算は、ユーザー指定に基づき「指値エントリーポイントとZigZagポイント間の距離の指定パーセンテージ」を使用する仕様に変更した。

